name: Test

on:
  push:
    branches: [ main, action-runner ]
  pull_request:
  workflow_dispatch:

jobs:
  test:
    name: Test
    runs-on: sidechain-launch-kit-runner
    container:
      image: ubuntu:20.04
    env:
      DEBIAN_FRONTEND: noninteractive

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Checkout rippled
        uses: actions/checkout@v3
        with:
          repository: ripple/rippled
          ref: sidechain
          path: ./rippled
        id: checkout-rippled

      - name: Install rippled dependencies
        run: |
          apt -y update
          apt -y install apt-transport-https ca-certificates wget gnupg git-all

      - name: Install boost
        uses: MarkusJx/install-boost@v2.1.0
        id: install-boost
        with:
          boost_version: 1.75.0

      - name: Get rippled commit hash
        run: |
          cd rippled
          sleep 1000000000
          echo "RIPPLED_COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV
          echo ${{join(steps.checkout-rippled.outputs.*, ',')}}
#          netstat -tulpn | grep LISTEN

      - name: Cache rippled
        id: check-cache
        uses: actions/cache@v2
        with:
          path: ./rippled/my_build
          key: rippled-${{ env.RIPPLED_COMMIT }}

      - name: Install rippled
        if: steps.check-cache.outputs.cache-hit != 'true'
        run: |
          cd rippled
          mkdir my_build
          cd my_build
          cmake ..
          ls -al
          cmake --build .
          ls
        env:
          BOOST_ROOT: ${{ steps.install-boost.outputs.BOOST_ROOT }}

      - name: Install poetry dependencies
        run: |
          python -m pip install --upgrade pip
          pip install poetry
          poetry install --no-dev

      - name: Run tests
        run: poetry run pytest tests/ --basetemp=./sidechain-tests --full-trace
        env:
          BOOST_ROOT: ${{ steps.install-boost.outputs.BOOST_ROOT }}
          RIPPLED_MAINCHAIN_EXE: ./rippled/my_build/rippled
          # version of rippled to run on the sidechain
          RIPPLED_SIDECHAIN_EXE: ./rippled/my_build/rippled
          # directory to store all the sidechain config stuff in
          RIPPLED_SIDECHAIN_CFG_DIR: ./sidechain_config
          # number of federators in the sidechain
          NUM_FEDERATORS: 3
          # mainnet node to connect to (use "standalone" or leave blank for standalone mode)
          MAINNET: standalone #34.83.125.234
          # mainnet port to connect to (should be the WS port). Only used if not in standalone mode.
          MAINNET_PORT: 51233
          # seed for the cross-chain token. Only used not in standalone.
          IOU_ISSUER: sEdTzT8zuY9BcwRwg892dVCz8HdhUG1
          # seed for the door account. Only used not in standalone.
          DOOR_ACCOUNT_SEED: spFuT3mE9zvnH1JF8Msz89MBn3GMj

      - name: Debug 1
        if: always()
        run: tail -1000 ./sidechain-tests/test_simple_xchain0/test_config_files_1/sidechain_testnet/sidechain_0/debug.log

      - name: Debug 2
        if: always()
        run: tail -1000 ./sidechain-tests/test_simple_xchain0/test_config_files_1/sidechain_testnet/sidechain_1/debug.log

      - name: Debug 3
        if: always()
        run: tail -1000 ./sidechain-tests/test_simple_xchain0/test_config_files_1/sidechain_testnet/sidechain_2/debug.log
